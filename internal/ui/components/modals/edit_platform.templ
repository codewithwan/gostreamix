package modals

import (
	"github.com/codewithwan/gostreamix/internal/ui/components/button"
	"github.com/codewithwan/gostreamix/internal/ui/components/card"
	"github.com/codewithwan/gostreamix/internal/ui/components/input"
	"github.com/codewithwan/gostreamix/internal/ui/utils"
	"github.com/codewithwan/gostreamix/internal/shared/middleware/i18n"
	"github.com/codewithwan/gostreamix/internal/ui/pages"
	t "github.com/a-h/templ"
)

templ EditPlatform(lang string, p pages.PlatformView) {
	<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" id="edit-platform-modal" onclick="if(event.target === this) this.remove()">
		<div class="w-full" style="max-width: 400px;" onclick="event.stopPropagation()">
			@card.Card() {
				@card.Header() {
					<div class="flex items-center justify-between">
						@card.Title() {
							{ i18n.Tr(lang, "platforms.modal.edit_title") }
						}
						<button class="text-muted-foreground hover:text-foreground transition-colors" onclick="document.getElementById('edit-platform-modal').remove()">
							<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
						</button>
					</div>
				}
				
				<form 
					hx-put={ "/dashboard/platforms/" + p.ID.String() } 
					hx-target={ "#platform-item-" + p.ID.String() } 
					hx-swap="outerHTML" 
					hx-on::after-request="if(event.detail.successful) document.getElementById('edit-platform-modal').remove()"
					class="space-y-4"
					id="edit-platform-form"
				>
					@card.Content(card.ContentProps{Class: "space-y-4"}) {
						
						// Platform Selection
						<div class="space-y-2">
							<label class="text-[10px] font-bold text-muted-foreground uppercase tracking-widest">{ i18n.Tr(lang, "platforms.modal.type_label") }</label>
							<div class="grid grid-cols-2 gap-2" id="edit-platform-grid">
								for _, plat := range AvailablePlatforms {
									<input type="radio" 
										name="platform_type" 
										value={ plat.ID } 
										id={ "edit-radio-" + plat.ID } 
										class="hidden" 
										checked?={ plat.ID == p.PlatformType }
									/>

									<div 
										id={ "edit-card-" + plat.ID } 
										class={ utils.TwMerge(
											"flex items-center gap-3 rounded-lg border p-2.5 cursor-pointer transition-all platform-card group",
											utils.IfElse(plat.ID == p.PlatformType, utils.TwMerge("border-primary ring-1 ring-primary/20", plat.BgClass), "border-border/60 bg-muted/10 hover:bg-muted/30 hover:border-primary/40 text-muted-foreground"),
										) }
										onclick={ templ.ComponentScript{
											Call: "selectEditPlatform('" + plat.ID + "')",
										} }
										data-platform-id={ plat.ID }
										data-bg-class={ plat.BgClass }
										data-border-class={ plat.BorderClass }
										data-text-class={ plat.ColorClass }
										data-rtmp-url={ plat.RTMPURL }
									>
										<div class={ 
											"flex items-center justify-center size-8 rounded-full bg-background/80 shadow-sm border border-border/50 transition-all group-hover:scale-110", 
											utils.IfElse(plat.ID == p.PlatformType, plat.ColorClass, "text-muted-foreground group-hover:" + plat.ColorClass) 
										}>
											<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
												@templ.Raw(plat.IconSVG)
											</svg>
										</div>
										<span class={ 
											"text-xs font-semibold transition-colors truncate", 
											utils.IfElse(plat.ID == p.PlatformType, "text-foreground", "text-muted-foreground group-hover:text-foreground") 
										}>{ plat.Name }</span>
									</div>
								}
							</div>
						</div>

						<div class="space-y-4 pt-2">
							<div class="space-y-1.5">
								<label class="text-[10px] font-bold text-muted-foreground uppercase tracking-widest" for="edit_name">{ i18n.Tr(lang, "platforms.modal.name_label") }</label>
								@input.Input(input.Props{
									ID:          "edit_name",
									Name:        "name",
									Type:        input.TypeText,
									Value:       p.Name,
									Placeholder: i18n.Tr(lang, "platforms.modal.name_placeholder"),
									Attributes:  t.Attributes{"required": true, "class": "h-9 text-sm bg-background/50"},
								})
							</div>
							
							<div class="space-y-1.5">
								<label class="text-[10px] font-bold text-muted-foreground uppercase tracking-widest" for="edit_custom_url">{ i18n.Tr(lang, "platforms.modal.url_label") }</label>
								@input.Input(input.Props{
									ID:          "edit_custom_url",
									Name:        "custom_url",
									Type:        input.TypeText,
									Value:       p.CustomURL,
									Placeholder: "rtmp://...",
									Attributes:  t.Attributes{"class": "h-9 text-sm font-mono bg-background/50"},
								})
							</div>

							<div class="space-y-1.5">
								<label class="text-[10px] font-bold text-muted-foreground uppercase tracking-widest" for="edit_stream_key">{ i18n.Tr(lang, "platforms.modal.key_label") }</label>
								@input.Input(input.Props{
									ID:          "edit_stream_key",
									Name:        "stream_key",
									Type:        input.TypePassword,
									Value:       p.StreamKey,
									Placeholder: "xxxx-xxxx-xxxx",
									Attributes:  t.Attributes{"required": true, "class": "h-9 text-sm font-mono bg-background/50"},
								})
							</div>
						</div>
					}

					@card.Footer(card.FooterProps{Class: "flex items-center justify-end gap-3 pt-2"}) {
						<button type="button" class="text-xs font-medium text-muted-foreground hover:text-foreground transition-colors" onclick="document.getElementById('edit-platform-modal').remove()">
							{ i18n.Tr(lang, "platforms.modal.cancel") }
						</button>
						@button.Button(button.Props{
							Type:    button.TypeSubmit,
							Variant: button.VariantDefault,
							Class:   "h-8 text-xs px-4",
						}) {
							{ i18n.Tr(lang, "platforms.modal.save") }
						}
					}
				</form>
			}
		</div>
	</div>

	<script>
		(function() {
			window.selectEditPlatform = function(type) {
				const cards = document.querySelectorAll('#edit-platform-modal .platform-card');
				const urlInput = document.getElementById('edit_custom_url');

				cards.forEach(card => {
					const id = card.getAttribute('data-platform-id');
					const radio = document.getElementById('edit-radio-' + id);
					const iconContainer = card.querySelector('div');
					const label = card.querySelector('span');
					
					const bgClass = card.getAttribute('data-bg-class');
					const borderClass = card.getAttribute('data-border-class');
					const textClass = card.getAttribute('data-text-class');
					const rtmpUrl = card.getAttribute('data-rtmp-url');

					if (id === type) {
						// Selected styles
						card.className = `flex items-center gap-3 rounded-lg border p-2.5 cursor-pointer transition-all platform-card group ring-1 ring-primary/20 ${bgClass} ${borderClass}`;
						iconContainer.className = `flex items-center justify-center size-8 rounded-full bg-background/80 shadow-sm border border-border/50 transition-all group-hover:scale-110 ${textClass}`;
						label.className = "text-xs font-semibold transition-colors truncate text-foreground";
						radio.checked = true;
						
						// Update URL Input
						if (urlInput) {
							urlInput.value = rtmpUrl || '';
						}
					} else {
						// Default styles
						card.className = "flex items-center gap-3 rounded-lg border p-2.5 cursor-pointer transition-all platform-card group border-border/60 bg-muted/10 hover:bg-muted/30 hover:border-primary/40 text-muted-foreground";
						iconContainer.className = `flex items-center justify-center size-8 rounded-full bg-background/80 shadow-sm border border-border/50 transition-all group-hover:scale-110 text-muted-foreground group-hover:${textClass}`;
						label.className = "text-xs font-semibold transition-colors truncate text-muted-foreground group-hover:text-foreground";
						radio.checked = false;
					}
				});

				if (type === 'custom' && urlInput) urlInput.focus();
			};
		})();
	</script>
}

FROM golang:1.25-alpine

WORKDIR /app

RUN apk add --no-cache \
    ffmpeg \
    git \
    nodejs \
    npm

ENV GOPROXY=https://proxy.golang.org,direct
ENV CGO_ENABLED=0

RUN go install github.com/air-verse/air@v1.63.0

COPY go.mod go.sum ./
RUN go mod download

COPY web/package.json web/package-lock.json ./web/
RUN npm ci --prefix ./web

COPY . .

RUN mkdir -p /app/tmp \
    /app/data/uploads \
    /app/data/thumbnails \
    /app/logs

EXPOSE 8080

HEALTHCHECK --interval=30s --timeout=10s --start-period=5s \
    CMD wget -q -O /dev/null http://127.0.0.1:8080/health || exit 1

CMD ["air", "-c", ".air.toml"]
